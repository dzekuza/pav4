generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   Int                   @id @default(autoincrement())
  email                String                @unique
  password             String
  isAdmin              Boolean               @default(false)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  favorites            favorites[]
  searchHistory        SearchHistory[]
  affiliateClicks      AffiliateClick[]
  affiliateConversions AffiliateConversion[]
  commissions          Commission[]
  sales                Sale[]

  @@map("users")
}

model SearchHistory {
  id        Int      @id @default(autoincrement())
  url       String
  title     String
  requestId String
  timestamp DateTime @default(now())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([timestamp])
  @@index([userId])
  @@map("search_history")
}

model LegacySearchHistory {
  id        Int      @id @default(autoincrement())
  userKey   String
  url       String
  timestamp DateTime @default(now())

  @@index([timestamp])
  @@index([userKey])
  @@map("legacy_search_history")
}

model Settings {
  id    Int    @id @default(autoincrement())
  key   String @unique
  value String
}

model Business {
  id                  Int                  @id @default(autoincrement())
  name                String
  domain              String               @unique
  website             String
  description         String?
  logo                String?
  isActive            Boolean              @default(true)
  isVerified          Boolean              @default(false)
  contactEmail        String?
  contactPhone        String?
  address             String?
  country             String?
  category            String?
  commission          Float                @default(0)
  email               String               @unique
  password            String
  totalVisits         Int                  @default(0)
  totalPurchases      Int                  @default(0)
  totalRevenue        Float                @default(0)
  adminCommissionRate Float                @default(5.0)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  affiliateId         String               @unique
  trackingVerified    Boolean              @default(false)
  clicks              BusinessClick[]
  conversions         BusinessConversion[]
  sales               Sale[]
  webhooks            Webhook[]
  commissionRates     CommissionRate[]
  trackingEvents      TrackingEvent[]

  @@map("businesses")
}

model ClickLog {
  id          Int      @id @default(autoincrement())
  affiliateId String
  productId   String
  userId      Int?
  timestamp   DateTime @default(now())
  userAgent   String?
  referrer    String?
  ip          String?
}

model Conversion {
  id         Int      @id @default(autoincrement())
  orderId    String
  amount     Float
  domain     String
  timestamp  DateTime @default(now())
  businessId String
  customerId String?

  @@index([businessId])
  @@index([timestamp])
}

model admins {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  name      String?
  role      String   @default("admin")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime
}

model affiliate_urls {
  id          Int      @id @default(autoincrement())
  name        String
  url         String
  description String?
  isActive    Boolean  @default(true)
  clicks      Int      @default(0)
  conversions Int      @default(0)
  revenue     Float    @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime
}

model favorites {
  id            Int      @id @default(autoincrement())
  userId        Int
  title         String
  price         String?
  currency      String?
  url           String
  image         String?
  store         String?
  merchant      String?
  stock         String?
  rating        Float?
  reviewsCount  Int?
  deliveryPrice String?
  details       String?
  returnPolicy  String?
  condition     String   @default("New")
  createdAt     DateTime @default(now())
  updatedAt     DateTime
  users         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([userId])
}

// New affiliate tracking models
model AffiliateClick {
  id           Int      @id @default(autoincrement())
  productUrl   String
  productTitle String?
  productPrice String?
  retailer     String?
  userId       Int?
  user         User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  sessionId    String?
  referrer     String?
  utmSource    String?
  utmMedium    String?
  utmCampaign  String?
  ipAddress    String?
  userAgent    String?
  timestamp    DateTime @default(now())

  @@map("affiliate_clicks")
}

model AffiliateConversion {
  id           Int      @id @default(autoincrement())
  productUrl   String
  productTitle String?
  productPrice String?
  retailer     String?
  userId       Int?
  user         User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  sessionId    String?
  referrer     String?
  utmSource    String?
  utmMedium    String?
  utmCampaign  String?
  ipAddress    String?
  userAgent    String?
  timestamp    DateTime @default(now())

  @@map("affiliate_conversions")
}

model BusinessClick {
  id           Int      @id @default(autoincrement())
  businessId   Int
  business     Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  productUrl   String
  productTitle String?
  productPrice String?
  retailer     String?
  sessionId    String?
  referrer     String?
  utmSource    String?
  utmMedium    String?
  utmCampaign  String?
  ipAddress    String?
  userAgent    String?
  timestamp    DateTime @default(now())

  @@map("business_clicks")
}

model BusinessConversion {
  id           Int      @id @default(autoincrement())
  businessId   Int
  business     Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  productUrl   String
  productTitle String?
  productPrice String?
  retailer     String?
  sessionId    String?
  referrer     String?
  utmSource    String?
  utmMedium    String?
  utmCampaign  String?
  ipAddress    String?
  userAgent    String?
  timestamp    DateTime @default(now())

  @@map("business_conversions")
}

// New models for complete sales tracking
model Sale {
  id               Int          @id @default(autoincrement())
  orderId          String       @unique
  businessId       Int
  business         Business     @relation(fields: [businessId], references: [id], onDelete: Cascade)
  userId           Int?
  user             User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  productUrl       String
  productTitle     String?
  productPrice     Float
  currency         String       @default("USD")
  retailer         String
  sessionId        String?
  referrer         String?
  utmSource        String?
  utmMedium        String?
  utmCampaign      String?
  ipAddress        String?
  userAgent        String?
  status           SaleStatus   @default(PENDING)
  commissionAmount Float?
  commissionRate   Float?
  commissionPaid   Boolean      @default(false)
  commissionPaidAt DateTime?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  commissions      Commission[]

  @@index([businessId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("sales")
}

model Commission {
  id        Int              @id @default(autoincrement())
  saleId    Int
  sale      Sale             @relation(fields: [saleId], references: [id], onDelete: Cascade)
  userId    Int
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount    Float
  rate      Float
  status    CommissionStatus @default(PENDING)
  paidAt    DateTime?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@index([userId])
  @@index([status])
  @@map("commissions")
}

model CommissionRate {
  id         Int      @id @default(autoincrement())
  businessId Int
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  retailer   String
  rate       Float
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([businessId, retailer])
  @@map("commission_rates")
}

model Webhook {
  id            Int            @id @default(autoincrement())
  businessId    Int
  business      Business       @relation(fields: [businessId], references: [id], onDelete: Cascade)
  url           String
  secret        String
  events        String[] // Array of event types to listen for
  isActive      Boolean        @default(true)
  lastTriggered DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  webhookEvents WebhookEvent[]

  @@map("webhooks")
}

model WebhookEvent {
  id           Int           @id @default(autoincrement())
  webhookId    Int
  webhook      Webhook       @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  eventType    String
  payload      String // JSON payload
  status       WebhookStatus @default(PENDING)
  responseCode Int?
  responseBody String?
  retryCount   Int           @default(0)
  nextRetryAt  DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([webhookId])
  @@index([status])
  @@map("webhook_events")
}

model TrackingEvent {
  id          Int      @id @default(autoincrement())
  eventType   String
  businessId  Int
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  affiliateId String
  platform    String   @default("universal")
  sessionId   String?
  userAgent   String?
  referrer    String?
  timestamp   DateTime @default(now())
  url         String?
  eventData   Json     @default("{}")
  ipAddress   String?

  @@index([businessId])
  @@index([eventType])
  @@index([timestamp])
  @@index([affiliateId])
  @@map("tracking_events")
}

// Enums for status tracking
enum SaleStatus {
  PENDING
  CONFIRMED
  CANCELLED
  REFUNDED
}

enum CommissionStatus {
  PENDING
  APPROVED
  PAID
  CANCELLED
}

enum WebhookStatus {
  PENDING
  SENT
  FAILED
  RETRY
}
