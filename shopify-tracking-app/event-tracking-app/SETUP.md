# Shopify Event Tracking App - Setup Guide

This guide will help you set up the Shopify Event Tracking App to forward all
Shopify events to your main application.

## Prerequisites

1. **Shopify Partner Account**: You need a Shopify Partner account to create and
   manage apps
2. **Node.js**: Version 18.20 or higher
3. **Main Application**: Your main application should be running and accessible
4. **Database**: PostgreSQL database for storing events (already configured in
   your main app)

## Step 1: Configure Environment Variables

Create a `.env` file in the `event-tracking-app` directory:

```env
# Shopify App Configuration (these will be auto-generated by Shopify CLI)
SHOPIFY_API_KEY=your_shopify_api_key
SHOPIFY_API_SECRET=your_shopify_api_secret
SHOPIFY_SCOPES=read_products,write_products,read_orders,write_orders,read_customers,write_customers,read_inventory,write_inventory,read_fulfillments,write_fulfillments,read_shipping,write_shipping,read_analytics,write_analytics,read_marketing_events,write_marketing_events,read_price_rules,write_price_rules,read_discounts,write_discounts,read_marketing_events,write_marketing_events,read_locales,write_locales,read_currencies,write_currencies,read_gift_cards,write_gift_cards,read_users,write_users,read_user_emails,write_user_emails,read_themes,write_themes,read_script_tags,write_script_tags,read_content,write_content,read_tender_transactions,write_tender_transactions,read_product_listings,write_product_listings,read_collections,write_collections,read_cart_transforms,write_cart_transforms,read_merchant_managed_fulfillment_orders,write_merchant_managed_fulfillment_orders,read_shopify_payments_payouts,write_shopify_payments_payouts,read_shopify_payments_disputes,write_shopify_payments_disputes
SHOPIFY_APP_URL=https://your-app-url.com

# Main Application Configuration
MAIN_APP_WEBHOOK_URL=https://your-main-app.com/api/shopify-webhooks
MAIN_APP_API_KEY=your-main-app-api-key

# Database Configuration (if using Prisma)
DATABASE_URL=your_database_url

# Environment
NODE_ENV=development
```

## Step 2: Configure Main Application

### 2.1 Add Environment Variable to Main App

Add this environment variable to your main application's `.env` file:

```env
SHOPIFY_WEBHOOK_API_KEY=your-secure-api-key-here
```

### 2.2 Update Main App Configuration

The main application already has the webhook endpoint at
`/api/shopify-webhooks`. Make sure your main app is running and accessible.

## Step 3: Deploy the Shopify App

### 3.1 Development Setup

1. **Navigate to the app directory**:
   ```bash
   cd shopify-tracking-app/event-tracking-app
   ```

2. **Install dependencies**:
   ```bash
   npm install
   ```

3. **Start development server**:
   ```bash
   npm run dev
   ```

4. **Follow the Shopify CLI prompts** to set up your app

### 3.2 Production Deployment

1. **Deploy to production**:
   ```bash
   npm run deploy
   ```

2. **Update environment variables** in your hosting platform with the production
   values

## Step 4: Configure Webhook Forwarding

### 4.1 Update App Configuration

The app is already configured with comprehensive webhook subscriptions in
`shopify.app.toml`. The configuration includes:

- **Orders**: create, update, paid, fulfilled, cancelled
- **Products**: create, update, delete
- **Customers**: create, update, delete
- **Carts**: create, update
- **Checkouts**: create, update, delete
- **Collections**: create, update, delete
- **Inventory**: create, update, delete
- **Fulfillments**: create, update
- **Refunds**: create

### 4.2 Test Webhook Delivery

1. **Trigger a test webhook**:
   ```bash
   shopify app webhook trigger --topic=orders/create
   ```

2. **Check your main application logs** to verify the webhook was received

3. **Check the Shopify app dashboard** at `/app/webhooks-dashboard` to monitor
   webhook status

## Step 5: Monitor and Verify

### 5.1 Check Webhook Dashboard

Access the webhook dashboard in your Shopify app:

- Go to your app in the Shopify admin
- Navigate to the "Webhook Dashboard" page
- Verify all webhook subscriptions are active
- Check the configuration information

### 5.2 Monitor Main Application

Check your main application for incoming webhooks:

1. **Check the webhook endpoint**:
   ```bash
   curl -X GET https://your-main-app.com/api/shopify-webhooks/stats
   ```

2. **Check application logs** for webhook processing

3. **Verify database records** - check the `shopify_events` table for new
   records

## Step 6: Troubleshooting

### Common Issues

1. **Webhook not forwarding**:
   - Verify `MAIN_APP_WEBHOOK_URL` is correct and accessible
   - Check `MAIN_APP_API_KEY` matches the key in your main app
   - Ensure your main app is running and the endpoint is working

2. **Authentication errors**:
   - Verify the API key in both the Shopify app and main app match
   - Check that the webhook source header is correct

3. **Database errors**:
   - Ensure the `shopify_events` table exists (run migrations if needed)
   - Check database connection and permissions

4. **Shopify app not receiving webhooks**:
   - Verify webhook subscriptions in the Partner Dashboard
   - Check app configuration and scopes
   - Ensure the app is properly installed on test stores

### Debug Steps

1. **Check Shopify app logs**:
   ```bash
   npm run dev
   # Look for webhook processing logs
   ```

2. **Check main app logs**:
   - Monitor your main application logs for webhook requests
   - Check for any validation or processing errors

3. **Test webhook manually**:
   ```bash
   curl -X POST https://your-main-app.com/api/shopify-webhooks \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer your-api-key" \
     -H "X-Webhook-Source: shopify-tracking-app" \
     -d '{
       "topic": "test/event",
       "shop_domain": "test.myshopify.com",
       "event_id": "test-123",
       "triggered_at": "2024-01-01T00:00:00Z",
       "payload": {"test": true},
       "timestamp": "2024-01-01T00:00:00Z",
       "source": "shopify-tracking-app"
     }'
   ```

## Step 7: Production Considerations

### 7.1 Security

- Use strong, unique API keys
- Enable HTTPS for all webhook endpoints
- Regularly rotate API keys
- Monitor webhook delivery and processing

### 7.2 Performance

- Monitor webhook processing times
- Implement proper error handling and retry logic
- Consider using a message queue for high-volume events
- Set up monitoring and alerting

### 7.3 Scalability

- The app is designed to handle multiple Shopify stores
- Each store's events are processed independently
- Consider database indexing for large event volumes
- Monitor database performance

## Step 8: Maintenance

### 8.1 Regular Tasks

- Monitor webhook delivery metrics in the Partner Dashboard
- Check application logs for errors
- Verify database performance and storage
- Update dependencies regularly

### 8.2 Updates

- Keep the Shopify app updated with the latest Shopify API versions
- Monitor for breaking changes in Shopify webhooks
- Update the main application as needed

## Support

If you encounter issues:

1. Check the Shopify Partner Dashboard for webhook delivery metrics
2. Review application logs for detailed error information
3. Use the webhook dashboard in the Shopify app for real-time status
4. Test webhook delivery using the Shopify CLI
5. Verify configuration and environment variables

## Next Steps

Once the setup is complete:

1. **Install the app on production stores**
2. **Monitor webhook delivery and processing**
3. **Set up alerts for webhook failures**
4. **Implement additional event processing as needed**
5. **Consider adding more webhook topics if required**

The Shopify Event Tracking App is now ready to forward all Shopify events to
your main application!
