import{j as e,A,c as X,R as w,d as $,E as B,H as Z}from"./vendor_ui-DPKP3YLX.js";import{r as n}from"./vendor_react-Bpl_dUPQ.js";import{B as o}from"./button-DP2dp-PV.js";import{C as N,a as ee,b as te,d as y}from"./card-CUmbL-D9.js";import{B as se}from"./badge-Cx_qSRgY.js";import{u as re,g as ae,t as ie,a as ce}from"./index-ZVa9_c7w.js";import{A as le,a as ne}from"./alert-DD_X1c11.js";import{u as oe,S as de}from"./SearchHeader-BXp9_NKE.js";import{S as me}from"./SearchInput-BPceslJ2.js";import{u as ue,A as xe}from"./AuthModal-CzmKQ8qE.js";import{b as he,u as fe,a as ge}from"./vendor_router-0FUT4RNd.js";import"./index-BrMgMA-w.js";import"./index-DxE6KrYo.js";import"./index-B6HsZdxu.js";import"./input-Bt03Fmew.js";import"./dialog-CLJAIzey.js";import"./AuthForms-Cj0L76cW.js";import"./label-Ci8XuWqp.js";import"./tabs-eeJMkpL9.js";function R(u){if(!u)return 0;const c=u.match(/[â‚¬$Â£]?\s?(\d+(?:[.,]\d{2})?)/);return c?parseFloat(c[1].replace(",",".")):0}function U(u){return u.includes("â‚¬")?"â‚¬":u.includes("$")?"$":u.includes("Â£")?"Â£":"â‚¬"}const Re=()=>{const{requestId:u}=he(),c=fe(),T=ge(),{toast:p}=re(),[x,E]=n.useState(null),[d,I]=n.useState([]),[z,b]=n.useState(!1),[L,P]=n.useState(null),[C,g]=n.useState(0),[O,S]=n.useState(""),[V,D]=n.useState(""),[H,q]=n.useState("de"),[j,k]=n.useState(new Map),[pe,je]=n.useState([]),{addFavorite:K,removeFavorite:G,checkFavorite:M}=oe(),{handleProtectedAction:J,modalProps:W}=ue({title:"Sign in to save favorites",description:"Create an account or sign in to save products to your favorites",defaultTab:"login",onSuccess:()=>{p({title:"Welcome back!",description:"You can now save products to your favorites"})}});n.useEffect(()=>{var t,r;(t=c.state)!=null&&t.searchUrl&&((r=c.state)!=null&&r.userCountry)&&_(c.state.searchUrl,c.state.userCountry,c.state.gl)},[c.state]);const _=async(t,r,i)=>{b(!0),P(null),g(1),S("Analyzing product...");try{await new Promise(a=>setTimeout(a,1e3)),S("Searching hundreds of retailers..."),g(2),await new Promise(a=>setTimeout(a,1500));const l=await fetch("/api/n8n-scrape",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:t,requestId:u,userLocation:{country:r},gl:i})});if(!l.ok){const a=await l.json();throw new Error(a.error||"Failed to fetch product data.")}S("Finalizing price comparisons..."),g(3),await new Promise(a=>setTimeout(a,800));const s=await l.json();if(s.mainProduct&&s.suggestions){const a={title:s.mainProduct.title,price:R(s.mainProduct.price),currency:U(s.mainProduct.price),image:s.mainProduct.image,url:s.mainProduct.url,store:new URL(s.mainProduct.url||t).hostname.replace(/^www\./,"")},h=s.suggestions.map(m=>({title:m.title,store:m.site||"unknown",price:R(m.standardPrice||m.discountPrice||"0"),currency:U(m.standardPrice||m.discountPrice||""),url:m.link,image:m.image,condition:"New",assessment:{cost:3,value:3,quality:3,description:`Found on ${m.site||"unknown"}`}}));E(a),I(h);const f=ae();ie({productUrl:t,sessionId:sessionStorage.getItem("pricehunt_session_id")||void 0,referrer:document.referrer,utmSource:f.utm_source,utmMedium:f.utm_medium,utmCampaign:f.utm_campaign}),h.length>0&&ce({productUrl:t,productTitle:a.title,productPrice:a.price.toString(),sessionId:sessionStorage.getItem("pricehunt_session_id")||void 0,referrer:document.referrer,utmSource:f.utm_source,utmMedium:f.utm_medium,utmCampaign:f.utm_campaign,alternatives:h})}else s.product&&s.comparisons?(E(s.product),I(s.comparisons)):P("No product data found");g(0),b(!1)}catch(l){console.error("Error fetching product data:",l),P(l instanceof Error?l.message:"An error occurred"),b(!1),g(0)}},v=()=>{var t,r;(t=c.state)!=null&&t.searchUrl&&((r=c.state)!=null&&r.userCountry)&&_(c.state.searchUrl,c.state.userCountry)},F=()=>{T("/")},Y=async t=>{t.trim()&&T(`/search-results/${Date.now()}`,{state:{searchUrl:t,userCountry:"Germany",gl:"de"}})},Q=async t=>{const r=`${t.store}-${t.title}`,i=j.get(r);J(async()=>{try{if(i!=null&&i.isFavorited&&i.favoriteId)await G(i.favoriteId),k(s=>{const a=new Map(s);return a.set(r,{isFavorited:!1}),a}),p({title:"Removed from favorites",description:"Item removed from your favorites"});else{const s=await K({title:t.title,price:t.price.toString(),currency:t.currency,url:t.url,image:t.image,store:t.store,merchant:t.merchant,stock:t.stock,rating:t.rating,reviewsCount:t.reviewsCount,deliveryPrice:t.deliveryPrice,details:t.details,returnPolicy:t.returnPolicy,condition:t.condition});k(a=>{const h=new Map(a);return h.set(r,{isFavorited:!0,favoriteId:s.id}),h}),p({title:"Added to favorites",description:"Item added to your favorites"})}}catch(s){p({title:"Error",description:s instanceof Error?s.message:"Failed to update favorites",variant:"destructive"})}})};return n.useEffect(()=>{(async()=>{if(d.length)for(const r of d){const i=`${r.store}-${r.title}`;if(!j.has(i)){const l=await M(r.url);k(s=>{const a=new Map(s);return a.set(i,l),a})}}})()},[d,M]),z?e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4",role:"status","aria-label":"Loading"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:O}),e.jsx("div",{className:"w-full max-w-md mx-auto bg-gray-200 rounded-full h-2",role:"progressbar","aria-label":"Loading progress",children:e.jsx("div",{className:`bg-blue-600 h-2 rounded-full transition-all duration-300 ${C===1?"w-1/3":C===2?"w-2/3":C===3?"w-full":"w-0"}`})})]})})}):L?e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-4 py-8",children:[e.jsxs(o,{onClick:F,variant:"ghost",className:"mb-4",children:[e.jsx(A,{className:"mr-2 h-4 w-4"}),"Back to Search"]}),e.jsxs(le,{className:"mb-4",children:[e.jsx(X,{className:"h-4 w-4"}),e.jsx(ne,{children:L})]}),e.jsxs(o,{onClick:v,className:"w-full",children:[e.jsx(w,{className:"mr-2 h-4 w-4"}),"Try Again"]})]})}):x?e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx(de,{}),e.jsxs("div",{className:"max-w-7xl mx-auto px-4 py-8",children:[e.jsxs(o,{onClick:F,variant:"ghost",className:"mb-6",children:[e.jsx(A,{className:"mr-2 h-4 w-4"}),"Back to Search"]}),e.jsx("div",{className:"mb-8",children:e.jsx(me,{value:V,onChange:t=>D(t),placeholder:"Enter product URL (e.g., Amazon, eBay, etc.)",onSubmit:Y,align:"left",selectedCountry:H,onCountryChange:q})}),e.jsxs(N,{className:"mb-8",children:[e.jsx(ee,{children:e.jsxs(te,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Original Product"}),e.jsx(se,{variant:"secondary",children:"Found"})]})}),e.jsx(y,{children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("img",{src:x.image,alt:x.title,className:"w-24 h-24 object-cover rounded-lg",onError:t=>{t.currentTarget.src="/placeholder.svg"}}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold",children:x.title}),e.jsxs("p",{className:"text-2xl font-bold text-green-600",children:[x.currency,x.price]}),e.jsxs("div",{className:"flex items-center mt-2",children:[e.jsx($,{className:"h-4 w-4 text-yellow-400 fill-current"}),e.jsx("span",{className:"ml-1 text-sm text-gray-600",children:"Original Price"})]})]}),x.url&&e.jsx(o,{asChild:!0,children:e.jsxs("a",{href:x.url,target:"_blank",rel:"noopener noreferrer","aria-label":"View original product details",children:[e.jsx(B,{className:"mr-2 h-4 w-4"}),"View Product"]})})]})})]}),d.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("h2",{className:"text-2xl font-bold text-gray-900",children:["Price Comparisons (",d.filter(t=>(t.price||0)>0).length,")"]}),e.jsxs(o,{onClick:v,variant:"outline",children:[e.jsx(w,{className:"mr-2 h-4 w-4"}),"Refresh"]})]}),e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:d.map((t,r)=>{const i=t.price||0;return{...t,extractedPrice:i,originalIndex:r}}).filter(t=>t.extractedPrice>0).sort((t,r)=>t.extractedPrice-r.extractedPrice).map((t,r)=>{var i,l;return e.jsx(N,{className:"hover:shadow-lg transition-shadow",children:e.jsx(y,{className:"p-4",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("img",{src:t.image,alt:t.store||"Store",className:"w-8 h-8 object-cover rounded border",onError:s=>{s.currentTarget.src="/placeholder.svg"}})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"flex items-center gap-2 mb-1",children:e.jsx("p",{className:"text-xs font-medium text-blue-600 capitalize",children:t.merchant||t.store||"Unknown Store"})}),e.jsx("h4",{className:"font-medium text-sm line-clamp-2 mb-2",children:t.title}),e.jsxs("p",{className:`text-lg font-bold ${t.extractedPrice>0&&r===0?"text-green-600":"text-gray-700"}`,children:[t.currency,t.price,t.extractedPrice>0&&r===0&&e.jsx("span",{className:"ml-2 text-xs bg-green-100 text-green-800 px-2 py-1 rounded",children:"Best Price"})]}),e.jsxs("div",{className:"flex items-center gap-3 text-xs text-muted-foreground mt-2",children:[t.stock&&e.jsxs("span",{className:`flex items-center gap-1 ${t.stock.toLowerCase().includes("in stock")?"text-green-600":"text-orange-600"}`,children:[t.stock.toLowerCase().includes("in stock")?"âœ…":"âš ï¸",t.stock]}),t.rating&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx($,{className:"h-3 w-3 fill-current text-yellow-400"}),e.jsx("span",{children:t.rating}),t.reviewsCount&&e.jsxs("span",{className:"text-xs",children:["(",t.reviewsCount,")"]})]}),t.deliveryPrice&&e.jsxs("span",{className:"text-xs",children:["ðŸšš ",t.deliveryPrice]})]}),t.details&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1 line-clamp-1",children:t.details}),e.jsxs("div",{className:"flex items-center mt-2",children:[e.jsx($,{className:"h-3 w-3 text-yellow-400 fill-current"}),e.jsx("span",{className:"ml-1 text-xs text-gray-600",children:t.assessment.description})]})]}),t.url&&e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx(o,{asChild:!0,size:"sm",variant:"outline",className:"flex-shrink-0",children:e.jsxs("a",{href:t.url,target:"_blank",rel:"noopener noreferrer",title:"View product details","aria-label":"View product details",children:[e.jsx(B,{className:"h-3 w-3"}),e.jsx("span",{className:"sr-only",children:"View product details"})]})}),e.jsx(o,{size:"sm",variant:"ghost",className:"flex-shrink-0 p-1 h-8 w-8",onClick:()=>Q(t),title:(i=j.get(`${t.store}-${t.title}`))!=null&&i.isFavorited?"Remove from favorites":"Add to favorites",children:e.jsx(Z,{className:`h-4 w-4 ${(l=j.get(`${t.store}-${t.title}`))!=null&&l.isFavorited?"fill-red-500 text-red-500":"text-gray-400 hover:text-red-500"}`})})]})]})})},t.originalIndex)})})]}),d.length===0&&e.jsx(N,{children:e.jsxs(y,{className:"p-8 text-center",children:[e.jsx("p",{className:"text-gray-500 mb-4",children:"No price comparisons found"}),e.jsxs(o,{onClick:v,children:[e.jsx(w,{className:"mr-2 h-4 w-4"}),"Try Again"]})]})}),d.length>0&&d.filter(t=>(t.price||0)>0).length===0&&e.jsx(N,{children:e.jsxs(y,{className:"p-8 text-center",children:[e.jsx("p",{className:"text-gray-500 mb-4",children:"No price comparisons with available prices found"}),e.jsx("p",{className:"text-sm text-gray-400 mb-4",children:"All found results have unavailable prices"}),e.jsxs(o,{onClick:v,children:[e.jsx(w,{className:"mr-2 h-4 w-4"}),"Try Again"]})]})})]}),e.jsx(xe,{...W})]}):e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"No product data available"}),e.jsxs(o,{onClick:F,children:[e.jsx(A,{className:"mr-2 h-4 w-4"}),"Back to Search"]})]})})})};export{Re as default};
