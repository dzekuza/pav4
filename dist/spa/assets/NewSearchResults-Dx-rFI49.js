import{j as e,A as L,c as V,R as S,d as G,E as J,C as le,k as ce,H as oe}from"./vendor_ui-6VDHAWyR.js";import{r as p}from"./vendor_react-Bpl_dUPQ.js";import{B as f}from"./button-DkTu2F27.js";import{C as g,a as ne,b as de,d as A}from"./card-BAjRuEEQ.js";import{B as me}from"./badge-CRJ5PX0Z.js";import{u as he,b as xe}from"./index-C2INySnl.js";import $ from"./dynamic-wave-canvas-background-BsPE4Tlt.js";import{A as ue,a as pe}from"./alert-DuKVxK9_.js";import{u as fe,S as O}from"./SearchHeader-5zoZ1kxO.js";import{S as we}from"./SearchInput-D81rw5Ko.js";import{a as je}from"./LoadingSkeleton-EL-UKxlG.js";import{u as be,A as ve}from"./AuthModal-DicyNdAp.js";import{b as Ne,u as ye,a as ke}from"./vendor_router-0FUT4RNd.js";import"./index-B2MitdoE.js";import"./index-D8EubtY5.js";import"./index-B8LjdZBf.js";import"./input-l4wrzjtr.js";import"./dialog-CorIUF4a.js";import"./AuthForms-DQlD-VsM.js";import"./label-CuJ9qwEk.js";import"./tabs-CdIcYuYS.js";function U(o){if(!o)return 0;const r=o.match(/[€$£]?\s?(\d+(?:[.,]\d{2})?)/);return r?parseFloat(r[1].replace(",",".")):0}function F(o){const r=o.match(/^[^\d]*/);return r?r[0].trim():""}function q(o){try{return`https://www.google.com/s2/favicons?domain=${new URL(o).hostname}&sz=64`}catch{return"/placeholder.svg"}}const Ge=()=>{var H;const{requestId:o}=Ne(),r=ye(),{toast:k}=he(),W=ke(),{addFavorite:_,removeFavorite:Y}=fe(),{isAuthenticated:I}=xe(),{handleProtectedAction:Q,modalProps:X}=be({title:"Sign in to save favorites",description:"Create an account or sign in to save products to your favorites",defaultTab:"login",onSuccess:()=>{k({title:"Welcome back!",description:"You can now save products to your favorites"})}}),[n,j]=p.useState(null),[b,N]=p.useState(""),[z,x]=p.useState(!1),[B,u]=p.useState(null),[R,M]=p.useState(new Map),[Z,K]=p.useState(""),[ee,te]=p.useState("de");p.useEffect(()=>{var t,a,s;if((t=r.state)!=null&&t.searchUrl&&(j(null),N(""),u(null),x(!0)),(a=r.state)!=null&&a.searchData)j(r.state.searchData),N(r.state.originalUrl||"");else if((s=r.state)!=null&&s.searchUrl)N(r.state.searchUrl),r.state.isKeywordSearch?D(r.state.searchUrl,r.state.userCountry,r.state.gl):P(r.state.searchUrl,r.state.userCountry,r.state.gl);else{const l=r.pathname.split("/").pop();if(l&&l!==o)try{const i=decodeURIComponent(l);if(i.includes("://")||i.startsWith("www.")){console.log("Extracted URL from slug:",i),N(i),P(i,"Germany","de");return}}catch{console.log("Could not decode slug as URL:",l)}re()}},[r.state,o,r.pathname]);const P=async(t,a,s)=>{var l,i;x(!0),u(null);try{console.log("Starting search with URL:",t,"Country:",a,"GL:",s);const c=await fetch("/api/n8n-scrape",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:t,requestId:o,userLocation:{country:a},gl:s})});if(!c.ok){const y=await c.json();throw new Error(y.error||"Failed to fetch search data")}const d=await c.json();console.log("Search response:",d);const h=Array.isArray(d)&&d.length===1&&((l=d[0])!=null&&l.mainProduct)&&((i=d[0])!=null&&i.suggestions)?d[0]:d;if(h.mainProduct&&h.suggestions){const y={title:h.mainProduct.title,price:U(h.mainProduct.price),currency:F(h.mainProduct.price),image:h.mainProduct.image,url:h.mainProduct.url,store:new URL(h.mainProduct.url||t).hostname.replace(/^www\./,"")},ie=h.suggestions.map(w=>({title:w.title,store:w.site||"unknown",price:U(w.standardPrice||w.discountPrice||"0"),currency:F(w.standardPrice||w.discountPrice||""),url:w.link,image:w.image,condition:"New",assessment:{cost:3,value:3,quality:3,description:`Found on ${w.site||"unknown"}`}}));j({mainProduct:y,suggestions:h.suggestions,comparisons:ie})}else j(h);x(!1)}catch(c){console.error("Search error:",c),u(c instanceof Error?c.message:"Failed to load search results"),x(!1)}},re=async()=>{if(o){x(!0),u(null);try{const t=await fetch("/api/n8n-scrape",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:b||"https://example.com",requestId:o})});if(t.ok){const a=await t.json();j(a)}else u("Failed to load search results")}catch{u("Failed to load search results")}finally{x(!1)}}},C=()=>{var t;b&&P(b,((t=r.state)==null?void 0:t.userCountry)||"Germany")},T=()=>{window.history.back()},ae=async t=>{if(!t.trim())return;let a=!1;try{const l=new URL(t.trim());a=!!l.protocol&&!!l.host}catch{a=!1}j(null),N(""),u(null),x(!0),K("");const s=Date.now().toString();W(`/new-search/${s}/search`,{replace:!0,state:{searchUrl:t.trim(),userCountry:"Germany",gl:"de",isKeywordSearch:!a}})},se=async t=>{const a=`${t.site}-${t.title}`,s=R.get(a);Q(async()=>{try{if(s!=null&&s.isFavorited&&s.favoriteId)await Y(s.favoriteId),M(i=>{const c=new Map(i);return c.set(a,{isFavorited:!1}),c}),k({title:"Removed from favorites",description:"Item removed from your favorites"});else{const i=await _({title:t.title,price:t.standardPrice||t.discountPrice,currency:F(t.standardPrice||t.discountPrice||""),url:t.link,image:t.image,store:t.site,merchant:t.merchant,stock:t.stock,rating:t.rating,reviewsCount:t.reviewsCount,deliveryPrice:t.deliveryPrice,details:t.details,returnPolicy:t.returnPolicy,condition:"New"});M(c=>{const d=new Map(c);return d.set(a,{isFavorited:!0,favoriteId:i.id}),d}),k({title:"Added to favorites",description:"Item added to your favorites"})}}catch(i){k({title:"Error",description:i instanceof Error?i.message:"Failed to update favorites",variant:"destructive"})}})},E=Array.isArray(n),v=E?n:n!=null&&n.suggestions?Array.isArray(n.suggestions)?n.suggestions:[n.suggestions]:[],m=E?null:n==null?void 0:n.mainProduct;p.useEffect(()=>{var t;return!n&&!z&&((t=r.state)!=null&&t.searchUrl)&&(x(!0),u(null),r.state.isKeywordSearch?D(r.state.searchUrl,r.state.userCountry,r.state.gl):P(r.state.searchUrl,r.state.userCountry,r.state.gl)),()=>{}},[r.state,o,r.pathname]);const D=async(t,a,s)=>{var l,i;x(!0),u(null);try{const c=await fetch("/api/n8n-scrape",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({keywords:t,requestId:o,userLocation:{country:a},gl:s})});if(!c.ok){const y=await c.json();throw new Error(y.error||"Failed to fetch search data")}const d=await c.json(),h=Array.isArray(d)&&d.length===1&&((l=d[0])!=null&&l.mainProduct)&&((i=d[0])!=null&&i.suggestions)?d[0]:d;j(h),x(!1)}catch(c){u(c instanceof Error?c.message:"Failed to load search results"),x(!1)}};return p.useEffect(()=>{var s,l;if(!I||!n||!b||!o)return;const t=((s=n.mainProduct)==null?void 0:s.title)||((l=n[0])==null?void 0:l.title)||b;let a=!1;!a&&t&&o&&(a=!0,fetch("/api/search-history",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({url:b,title:t,requestId:o})}))},[I,n,b,o]),z?e.jsx(je,{}):B?e.jsxs("div",{className:"relative min-h-screen overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 -z-20",children:e.jsx($,{})}),e.jsx("div",{className:"absolute inset-0 -z-10",children:e.jsx("div",{className:"absolute inset-x-0 top-0 h-40 bg-gradient-to-b from-black/20 to-transparent"})}),e.jsx(O,{}),e.jsxs("div",{className:"max-w-6xl mx-auto px-6 py-10",children:[e.jsxs(f,{onClick:T,variant:"ghost",className:"mb-4",children:[e.jsx(L,{className:"mr-2 h-4 w-4"}),"Back"]}),e.jsxs(ue,{className:"mb-4 border-white/10 bg-white/10 backdrop-blur-md text-white",children:[e.jsx(V,{className:"h-4 w-4"}),e.jsx(pe,{children:B})]}),e.jsxs(f,{onClick:C,className:"w-full rounded-full bg-white text-black border border-black/10 hover:bg-white/90",children:[e.jsx(S,{className:"mr-2 h-4 w-4"}),"Try Again"]})]})]}):n?e.jsxs("div",{className:"relative min-h-screen overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 -z-20",children:e.jsx($,{})}),e.jsx("div",{className:"absolute inset-0 -z-10",children:e.jsx("div",{className:"absolute inset-0 bg-gradient-to-b from-black/40 via-black/60 to-black"})}),e.jsx(O,{}),e.jsxs("div",{className:"max-w-6xl mx-auto px-6 py-10",children:[e.jsxs(f,{onClick:T,variant:"ghost",className:"mb-6 text-white hover:text-white",children:[e.jsx(L,{className:"mr-2 h-4 w-4"}),"Back to Search"]}),e.jsx("div",{className:"mb-8",children:e.jsx(we,{value:Z,onChange:t=>K(t),placeholder:"Enter product URL (e.g., Amazon, eBay, etc.)",onSubmit:ae,align:"left",selectedCountry:ee,onCountryChange:te})}),m&&!E&&!((H=r.state)!=null&&H.isKeywordSearch)&&e.jsxs(g,{className:"mb-8 border-white/10 bg-white/5 backdrop-blur-xl text-white",children:[e.jsx(ne,{children:e.jsxs(de,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Original Product"}),e.jsx(me,{variant:"secondary",className:"bg-white text-black",children:"Found"})]})}),e.jsx(A,{children:e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center space-y-4 sm:space-y-0 sm:space-x-4",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("img",{src:m.image&&!m.image.includes("placeholder")&&!m.image.includes("fallback")?m.image:q(m.url),alt:m.title,className:"w-20 h-20 sm:w-24 sm:h-24 object-cover rounded-lg",onError:t=>{t.currentTarget.src=q(m.url)}})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold line-clamp-2",children:m.title}),e.jsxs("p",{className:"text-xl sm:text-2xl font-bold text-green-400 mt-1",children:[m.currency,m.price]}),e.jsxs("div",{className:"flex items-center mt-2",children:[e.jsx(G,{className:"h-4 w-4 text-yellow-300 fill-current"}),e.jsx("span",{className:"ml-1 text-sm text-white/70",children:"Original Price"})]})]}),m.url&&e.jsx("div",{className:"flex-shrink-0 w-full sm:w-auto",children:e.jsx(f,{asChild:!0,className:"w-full sm:w-auto rounded-full bg-white text-black hover:bg-white/90",children:e.jsxs("a",{href:`/api/redirect?to=${encodeURIComponent(m.url)}`,target:"_blank",rel:"noopener noreferrer","aria-label":"View original product details",children:[e.jsx(J,{className:"mr-2 h-4 w-4"}),"View Product"]})})})]})})]}),v.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between mb-6 gap-4",children:[e.jsxs("h2",{className:"text-xl sm:text-2xl font-bold text-white",children:["Results (",v.length,")"]}),e.jsxs(f,{onClick:C,variant:"outline",className:"w-full sm:w-auto",children:[e.jsx(S,{className:"mr-2 h-4 w-4"}),"Refresh"]})]}),e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:v.map((t,a)=>{var s,l;return U(t.standardPrice||t.discountPrice||"0"),F(t.standardPrice||t.discountPrice||""),e.jsx(g,{className:"hover:shadow-lg transition-shadow border-white/10 bg-white/5 backdrop-blur-xl text-white",children:e.jsx(A,{className:"p-4",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("img",{src:t.image||"/placeholder.svg",alt:t.site||"Store",className:"w-8 h-8 object-cover rounded border border-white/20",onError:i=>{i.currentTarget.src="/placeholder.svg"}})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs font-medium text-white/80 mb-1 capitalize",children:t.merchant||t.site||"Unknown Store"}),e.jsx("h4",{className:"font-medium text-sm line-clamp-2 mb-2",children:t.title}),(t.standardPrice||t.discountPrice)&&e.jsx("div",{className:"flex items-center gap-2 mb-2",children:e.jsx("p",{className:"text-lg font-bold text-white",children:t.standardPrice||t.discountPrice})}),e.jsxs("div",{className:"flex flex-col gap-2 text-xs text-white/70",children:[t.stock&&e.jsxs("div",{className:`flex items-center gap-1 ${t.stock.toLowerCase().includes("in stock")?"text-green-400":"text-orange-400"}`,children:[t.stock.toLowerCase().includes("in stock")?e.jsx(le,{className:"h-3 w-3 fill-current"}):e.jsx(V,{className:"h-3 w-3"}),e.jsx("span",{className:"font-medium",children:t.stock})]}),t.rating&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(G,{className:"h-3 w-3 fill-current text-yellow-300"}),e.jsx("span",{children:t.rating}),t.reviewsCount&&e.jsxs("span",{className:"text-xs",children:["(",t.reviewsCount,")"]})]}),t.deliveryPrice&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ce,{className:"h-3 w-3"}),e.jsx("span",{children:t.deliveryPrice})]})]}),t.details&&e.jsx("p",{className:"text-xs text-white/60 mt-2 line-clamp-1",children:t.details})]}),t.link&&e.jsxs("div",{className:"flex flex-col gap-2 flex-shrink-0",children:[e.jsx(f,{asChild:!0,size:"sm",variant:"outline",className:"flex-shrink-0 rounded-full bg-white text-black border border-black/10 hover:bg-white/90",children:e.jsxs("a",{href:`/api/redirect?to=${encodeURIComponent(t.link)}`,target:"_blank",rel:"noopener noreferrer",title:"View product details","aria-label":"View product details",children:[e.jsx(J,{className:"h-3 w-3"}),e.jsx("span",{className:"sr-only",children:"View product details"})]})}),e.jsx(f,{size:"sm",variant:"ghost",className:"flex-shrink-0 p-1 h-8 w-8",onClick:()=>se(t),title:(s=R.get(`${t.site}-${t.title}`))!=null&&s.isFavorited?"Remove from favorites":"Add to favorites",children:e.jsx(oe,{className:`h-4 w-4 ${(l=R.get(`${t.site}-${t.title}`))!=null&&l.isFavorited?"fill-red-500 text-red-500":"text-gray-300 hover:text-red-500"}`})})]})]})})},a)})})]}),v.length===0&&e.jsx(g,{className:"border-white/10 bg-white/5 backdrop-blur-xl text-white",children:e.jsxs(A,{className:"p-8 text-center",children:[e.jsx("p",{className:"text-white/70 mb-4",children:"No price comparisons found"}),e.jsxs(f,{onClick:C,className:"rounded-full bg-white text-black border border-black/10 hover:bg-white/90",children:[e.jsx(S,{className:"mr-2 h-4 w-4"}),"Try Again"]})]})}),v.length>0&&v.filter(t=>U(t.standardPrice||t.discountPrice||"0")>0).length===0&&e.jsx(g,{className:"border-white/10 bg-white/5 backdrop-blur-xl text-white",children:e.jsxs(A,{className:"p-8 text-center",children:[e.jsx("p",{className:"text-white/70 mb-4",children:"No price comparisons with available prices found"}),e.jsx("p",{className:"text-sm text-white/60 mb-4",children:"All found results have unavailable prices"}),e.jsxs(f,{onClick:C,className:"rounded-full bg-white text-black border border-black/10 hover:bg-white/90",children:[e.jsx(S,{className:"mr-2 h-4 w-4"}),"Try Again"]})]})})]}),e.jsx(ve,{...X})]}):e.jsxs("div",{className:"relative min-h-screen overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 -z-20",children:e.jsx($,{})}),e.jsx(O,{}),e.jsx("div",{className:"max-w-6xl mx-auto px-6 py-10",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h2",{className:"text-xl font-semibold text-white mb-4",children:"No search data available"}),e.jsxs(f,{onClick:T,className:"rounded-full bg-white text-black border border-black/10 hover:bg-white/90",children:[e.jsx(L,{className:"mr-2 h-4 w-4"}),"Back"]})]})})]})};export{Ge as default};
