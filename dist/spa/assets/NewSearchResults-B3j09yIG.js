import{j as e,A as T,c as D,R as S,d as H,E as V,C as ae,k as se,H as le}from"./vendor_ui-DPKP3YLX.js";import{r as x}from"./vendor_react-Bpl_dUPQ.js";import{B as u}from"./button-BVbCSO_a.js";import{C as P,a as ie,b as ce,d as C}from"./card-C3AOPTFZ.js";import{B as oe}from"./badge-CNTn68H-.js";import{u as ne,b as de}from"./index-Bm7-4qCY.js";import E from"./dynamic-wave-canvas-background-D9w7BRFD.js";import{A as me,a as he}from"./alert-CdpANgE4.js";import{u as xe,S as L}from"./SearchHeader-BQRgaaLe.js";import{S as ue}from"./SearchInput-BUDMWeSJ.js";import{a as fe}from"./LoadingSkeleton-BrahVsGD.js";import{u as pe,A as we}from"./AuthModal-DdX3VqK_.js";import{b as je,u as be,a as ve}from"./vendor_router-0FUT4RNd.js";import"./index-DjoQLnK1.js";import"./index-BLqSjk83.js";import"./index-fqsw_NIb.js";import"./input--XZmn13O.js";import"./dialog-C3oruSML.js";import"./AuthForms-Bj6aRA0D.js";import"./label-09uxue2U.js";import"./tabs-DMdJGpTX.js";function g(c){if(!c)return 0;const r=c.match(/[€$£]?\s?(\d+(?:[.,]\d{2})?)/);return r?parseFloat(r[1].replace(",",".")):0}function U(c){const r=c.match(/^[^\d]*/);return r?r[0].trim():""}function G(c){try{return`https://www.google.com/s2/favicons?domain=${new URL(c).hostname}&sz=64`}catch{return"/placeholder.svg"}}const De=()=>{var K;const{requestId:c}=je(),r=be(),{toast:v}=ne(),J=ve(),{addFavorite:q,removeFavorite:W}=xe(),{isAuthenticated:O}=de(),{handleProtectedAction:_,modalProps:Y}=pe({title:"Sign in to save favorites",description:"Create an account or sign in to save products to your favorites",defaultTab:"login",onSuccess:()=>{v({title:"Welcome back!",description:"You can now save products to your favorites"})}}),[o,p]=x.useState(null),[w,b]=x.useState(""),[$,d]=x.useState(!1),[z,m]=x.useState(null),[A,B]=x.useState(new Map),[Q,I]=x.useState(""),[X,Z]=x.useState("de");x.useEffect(()=>{var t,l,i;if((t=r.state)!=null&&t.searchUrl&&(p(null),b(""),m(null),d(!0)),(l=r.state)!=null&&l.searchData)p(r.state.searchData),b(r.state.originalUrl||"");else if((i=r.state)!=null&&i.searchUrl)b(r.state.searchUrl),r.state.isKeywordSearch?M(r.state.searchUrl,r.state.userCountry,r.state.gl):N(r.state.searchUrl,r.state.userCountry,r.state.gl);else{const s=r.pathname.split("/").pop();if(s&&s!==c)try{const a=decodeURIComponent(s);if(a.includes("://")||a.startsWith("www.")){console.log("Extracted URL from slug:",a),b(a),N(a,"Germany","de");return}}catch{console.log("Could not decode slug as URL:",s)}ee()}},[r.state,c,r.pathname]);const N=async(t,l,i)=>{d(!0),m(null);try{console.log("Starting search with URL:",t,"Country:",l,"GL:",i);const s=await fetch("/api/n8n-scrape",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:t,requestId:c,userLocation:{country:l},gl:i})});if(!s.ok){const h=await s.json();throw new Error(h.error||"Failed to fetch search data")}const a=await s.json();if(console.log("Search response:",a),a.mainProduct&&a.suggestions){const h={title:a.mainProduct.title,price:g(a.mainProduct.price),currency:U(a.mainProduct.price),image:a.mainProduct.image,url:a.mainProduct.url,store:new URL(a.mainProduct.url||t).hostname.replace(/^www\./,"")},k=a.suggestions.map(f=>({title:f.title,store:f.site||"unknown",price:g(f.standardPrice||f.discountPrice||"0"),currency:U(f.standardPrice||f.discountPrice||""),url:f.link,image:f.image,condition:"New",assessment:{cost:3,value:3,quality:3,description:`Found on ${f.site||"unknown"}`}}));p({mainProduct:h,suggestions:a.suggestions,comparisons:k})}else p(a);d(!1)}catch(s){console.error("Search error:",s),m(s instanceof Error?s.message:"Failed to load search results"),d(!1)}},ee=async()=>{if(c){d(!0),m(null);try{const t=await fetch("/api/n8n-scrape",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:w||"https://example.com",requestId:c})});if(t.ok){const l=await t.json();p(l)}else m("Failed to load search results")}catch{m("Failed to load search results")}finally{d(!1)}}},y=()=>{var t;w&&N(w,((t=r.state)==null?void 0:t.userCountry)||"Germany")},F=()=>{window.history.back()},te=async t=>{if(!t.trim())return;let l=!1;try{const s=new URL(t.trim());l=!!s.protocol&&!!s.host}catch{l=!1}p(null),b(""),m(null),d(!0),I("");const i=Date.now().toString();J(`/new-search/${i}/search`,{replace:!0,state:{searchUrl:t.trim(),userCountry:"Germany",gl:"de",isKeywordSearch:!l}})},re=async t=>{const l=`${t.site}-${t.title}`,i=A.get(l);_(async()=>{try{if(i!=null&&i.isFavorited&&i.favoriteId)await W(i.favoriteId),B(a=>{const h=new Map(a);return h.set(l,{isFavorited:!1}),h}),v({title:"Removed from favorites",description:"Item removed from your favorites"});else{const a=await q({title:t.title,price:t.standardPrice||t.discountPrice,currency:U(t.standardPrice||t.discountPrice||""),url:t.link,image:t.image,store:t.site,merchant:t.merchant,stock:t.stock,rating:t.rating,reviewsCount:t.reviewsCount,deliveryPrice:t.deliveryPrice,details:t.details,returnPolicy:t.returnPolicy,condition:"New"});B(h=>{const k=new Map(h);return k.set(l,{isFavorited:!0,favoriteId:a.id}),k}),v({title:"Added to favorites",description:"Item added to your favorites"})}}catch(a){v({title:"Error",description:a instanceof Error?a.message:"Failed to update favorites",variant:"destructive"})}})},R=Array.isArray(o),j=R?o:o!=null&&o.suggestions?Array.isArray(o.suggestions)?o.suggestions:[o.suggestions]:[],n=R?null:o==null?void 0:o.mainProduct;x.useEffect(()=>{var t;return!o&&!$&&((t=r.state)!=null&&t.searchUrl)&&(d(!0),m(null),r.state.isKeywordSearch?M(r.state.searchUrl,r.state.userCountry,r.state.gl):N(r.state.searchUrl,r.state.userCountry,r.state.gl)),()=>{}},[r.state,c,r.pathname]);const M=async(t,l,i)=>{d(!0),m(null);try{const s=await fetch("/api/n8n-scrape",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({keywords:t,requestId:c,userLocation:{country:l},gl:i})});if(!s.ok){const h=await s.json();throw new Error(h.error||"Failed to fetch search data")}const a=await s.json();p(a),d(!1)}catch(s){m(s instanceof Error?s.message:"Failed to load search results"),d(!1)}};return x.useEffect(()=>{var i,s;if(!O||!o||!w||!c)return;const t=((i=o.mainProduct)==null?void 0:i.title)||((s=o[0])==null?void 0:s.title)||w;let l=!1;!l&&t&&c&&(l=!0,fetch("/api/search-history",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({url:w,title:t,requestId:c})}))},[O,o,w,c]),$?e.jsx(fe,{}):z?e.jsxs("div",{className:"relative min-h-screen overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 -z-20",children:e.jsx(E,{})}),e.jsx("div",{className:"absolute inset-0 -z-10",children:e.jsx("div",{className:"absolute inset-x-0 top-0 h-40 bg-gradient-to-b from-black/20 to-transparent"})}),e.jsx(L,{}),e.jsxs("div",{className:"max-w-6xl mx-auto px-6 py-10",children:[e.jsxs(u,{onClick:F,variant:"ghost",className:"mb-4",children:[e.jsx(T,{className:"mr-2 h-4 w-4"}),"Back"]}),e.jsxs(me,{className:"mb-4 border-white/10 bg-white/10 backdrop-blur-md text-white",children:[e.jsx(D,{className:"h-4 w-4"}),e.jsx(he,{children:z})]}),e.jsxs(u,{onClick:y,className:"w-full rounded-full bg-white text-black border border-black/10 hover:bg-white/90",children:[e.jsx(S,{className:"mr-2 h-4 w-4"}),"Try Again"]})]})]}):o?e.jsxs("div",{className:"relative min-h-screen overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 -z-20",children:e.jsx(E,{})}),e.jsx("div",{className:"absolute inset-0 -z-10",children:e.jsx("div",{className:"absolute inset-0 bg-gradient-to-b from-black/40 via-black/60 to-black"})}),e.jsx(L,{}),e.jsxs("div",{className:"max-w-6xl mx-auto px-6 py-10",children:[e.jsxs(u,{onClick:F,variant:"ghost",className:"mb-6 text-white hover:text-white",children:[e.jsx(T,{className:"mr-2 h-4 w-4"}),"Back to Search"]}),e.jsx("div",{className:"mb-8",children:e.jsx(ue,{value:Q,onChange:t=>I(t),placeholder:"Enter product URL (e.g., Amazon, eBay, etc.)",onSubmit:te,align:"left",selectedCountry:X,onCountryChange:Z})}),n&&!R&&!((K=r.state)!=null&&K.isKeywordSearch)&&e.jsxs(P,{className:"mb-8 border-white/10 bg-white/5 backdrop-blur-xl text-white",children:[e.jsx(ie,{children:e.jsxs(ce,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Original Product"}),e.jsx(oe,{variant:"secondary",className:"bg-white text-black",children:"Found"})]})}),e.jsx(C,{children:e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center space-y-4 sm:space-y-0 sm:space-x-4",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("img",{src:n.image&&!n.image.includes("placeholder")&&!n.image.includes("fallback")?n.image:G(n.url),alt:n.title,className:"w-20 h-20 sm:w-24 sm:h-24 object-cover rounded-lg",onError:t=>{t.currentTarget.src=G(n.url)}})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold line-clamp-2",children:n.title}),e.jsxs("p",{className:"text-xl sm:text-2xl font-bold text-green-400 mt-1",children:[n.currency,n.price]}),e.jsxs("div",{className:"flex items-center mt-2",children:[e.jsx(H,{className:"h-4 w-4 text-yellow-300 fill-current"}),e.jsx("span",{className:"ml-1 text-sm text-white/70",children:"Original Price"})]})]}),n.url&&e.jsx("div",{className:"flex-shrink-0 w-full sm:w-auto",children:e.jsx(u,{asChild:!0,className:"w-full sm:w-auto rounded-full bg-white text-black hover:bg-white/90",children:e.jsxs("a",{href:n.url,target:"_blank",rel:"noopener noreferrer","aria-label":"View original product details",children:[e.jsx(V,{className:"mr-2 h-4 w-4"}),"View Product"]})})})]})})]}),j.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between mb-6 gap-4",children:[e.jsxs("h2",{className:"text-xl sm:text-2xl font-bold text-white",children:["Results (",j.length,")"]}),e.jsxs(u,{onClick:y,variant:"outline",className:"w-full sm:w-auto",children:[e.jsx(S,{className:"mr-2 h-4 w-4"}),"Refresh"]})]}),e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:j.map((t,l)=>{var i,s;return g(t.standardPrice||t.discountPrice||"0"),U(t.standardPrice||t.discountPrice||""),e.jsx(P,{className:"hover:shadow-lg transition-shadow border-white/10 bg-white/5 backdrop-blur-xl text-white",children:e.jsx(C,{className:"p-4",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("img",{src:t.image||"/placeholder.svg",alt:t.site||"Store",className:"w-8 h-8 object-cover rounded border border-white/20",onError:a=>{a.currentTarget.src="/placeholder.svg"}})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs font-medium text-white/80 mb-1 capitalize",children:t.merchant||t.site||"Unknown Store"}),e.jsx("h4",{className:"font-medium text-sm line-clamp-2 mb-2",children:t.title}),(t.standardPrice||t.discountPrice)&&e.jsx("div",{className:"flex items-center gap-2 mb-2",children:e.jsx("p",{className:"text-lg font-bold text-white",children:t.standardPrice||t.discountPrice})}),e.jsxs("div",{className:"flex flex-col gap-2 text-xs text-white/70",children:[t.stock&&e.jsxs("div",{className:`flex items-center gap-1 ${t.stock.toLowerCase().includes("in stock")?"text-green-400":"text-orange-400"}`,children:[t.stock.toLowerCase().includes("in stock")?e.jsx(ae,{className:"h-3 w-3 fill-current"}):e.jsx(D,{className:"h-3 w-3"}),e.jsx("span",{className:"font-medium",children:t.stock})]}),t.rating&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(H,{className:"h-3 w-3 fill-current text-yellow-300"}),e.jsx("span",{children:t.rating}),t.reviewsCount&&e.jsxs("span",{className:"text-xs",children:["(",t.reviewsCount,")"]})]}),t.deliveryPrice&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(se,{className:"h-3 w-3"}),e.jsx("span",{children:t.deliveryPrice})]})]}),t.details&&e.jsx("p",{className:"text-xs text-white/60 mt-2 line-clamp-1",children:t.details})]}),t.link&&e.jsxs("div",{className:"flex flex-col gap-2 flex-shrink-0",children:[e.jsx(u,{asChild:!0,size:"sm",variant:"outline",className:"flex-shrink-0 rounded-full bg-white text-black border border-black/10 hover:bg-white/90",children:e.jsxs("a",{href:t.link,target:"_blank",rel:"noopener noreferrer",title:"View product details","aria-label":"View product details",children:[e.jsx(V,{className:"h-3 w-3"}),e.jsx("span",{className:"sr-only",children:"View product details"})]})}),e.jsx(u,{size:"sm",variant:"ghost",className:"flex-shrink-0 p-1 h-8 w-8",onClick:()=>re(t),title:(i=A.get(`${t.site}-${t.title}`))!=null&&i.isFavorited?"Remove from favorites":"Add to favorites",children:e.jsx(le,{className:`h-4 w-4 ${(s=A.get(`${t.site}-${t.title}`))!=null&&s.isFavorited?"fill-red-500 text-red-500":"text-gray-300 hover:text-red-500"}`})})]})]})})},l)})})]}),j.length===0&&e.jsx(P,{className:"border-white/10 bg-white/5 backdrop-blur-xl text-white",children:e.jsxs(C,{className:"p-8 text-center",children:[e.jsx("p",{className:"text-white/70 mb-4",children:"No price comparisons found"}),e.jsxs(u,{onClick:y,className:"rounded-full bg-white text-black border border-black/10 hover:bg-white/90",children:[e.jsx(S,{className:"mr-2 h-4 w-4"}),"Try Again"]})]})}),j.length>0&&j.filter(t=>g(t.standardPrice||t.discountPrice||"0")>0).length===0&&e.jsx(P,{className:"border-white/10 bg-white/5 backdrop-blur-xl text-white",children:e.jsxs(C,{className:"p-8 text-center",children:[e.jsx("p",{className:"text-white/70 mb-4",children:"No price comparisons with available prices found"}),e.jsx("p",{className:"text-sm text-white/60 mb-4",children:"All found results have unavailable prices"}),e.jsxs(u,{onClick:y,className:"rounded-full bg-white text-black border border-black/10 hover:bg-white/90",children:[e.jsx(S,{className:"mr-2 h-4 w-4"}),"Try Again"]})]})})]}),e.jsx(we,{...Y})]}):e.jsxs("div",{className:"relative min-h-screen overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 -z-20",children:e.jsx(E,{})}),e.jsx(L,{}),e.jsx("div",{className:"max-w-6xl mx-auto px-6 py-10",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h2",{className:"text-xl font-semibold text-white mb-4",children:"No search data available"}),e.jsxs(u,{onClick:F,className:"rounded-full bg-white text-black border border-black/10 hover:bg-white/90",children:[e.jsx(T,{className:"mr-2 h-4 w-4"}),"Back"]})]})})]})};export{De as default};
