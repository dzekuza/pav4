import{j as e,c as te,R as q,v as p,t as S,D as se,F as ae,i as re}from"./vendor_ui-DPKP3YLX.js";import{r as n}from"./vendor_react-Bpl_dUPQ.js";import{C as w,a as g,b as f,d as j}from"./card-BoaCPfwL.js";import{B as d}from"./button-BcPegbQV.js";import{B as h}from"./badge-B0xV9cVX.js";import{T as ie,a as ce,b as G,c as b,d as le,e as N}from"./table-nekdZBkB.js";import"./index-D26ovBZe.js";import"./vendor_router-0FUT4RNd.js";function we(){const[K,M]=n.useState([]),[Q,D]=n.useState(!0),[v,$]=n.useState(!1),[U,B]=n.useState(null),[r,x]=n.useState("all"),[y,W]=n.useState({totalClicks:0,totalPurchases:0,totalRevenue:0,conversionRate:0,totalAddToCart:0,totalPageViews:0,totalProductViews:0,cartToPurchaseRate:0,averageOrderValue:0,totalSessions:0});n.useEffect(()=>{O()},[]);const O=async(s=!1)=>{try{s?$(!0):D(!0),B(null);const[c,u,L]=await Promise.all([fetch("/api/business/activity/clicks",{credentials:"include"}),fetch("/api/business/activity/conversions",{credentials:"include"}),fetch("/api/business/activity/events",{credentials:"include"})]);if(!c.ok||!u.ok||!L.ok)throw new Error("Failed to fetch activity data");const k=await c.json(),A=await u.json(),C=await L.json(),I=Array.isArray(k)?k:k.clicks||[],P=Array.isArray(A)?A:A.conversions||[],l=Array.isArray(C)?C:C.events||[],J=[...I.map(t=>({id:`click-${t.id}`,type:"click",productName:F(t.productUrl),productUrl:t.productUrl,status:"browsed",timestamp:t.timestamp,userAgent:t.userAgent,referrer:t.referrer,ip:t.ipAddress})),...P.map(t=>({id:`conversion-${t.id}`,type:"conversion",productName:t.productTitle||F(t.productUrl),productUrl:t.productUrl,status:"purchased",amount:t.productPrice?parseFloat(t.productPrice):void 0,timestamp:t.timestamp,userAgent:t.userAgent,referrer:t.referrer,ip:t.ipAddress})),...l.map(t=>{const a=typeof t.eventData=="string"?JSON.parse(t.eventData):t.eventData;let i="click",o="browsed",m="Product",z;switch(t.eventType){case"add_to_cart":i="add_to_cart",o="added_to_cart",m=a.product_name||"Product";break;case"purchase":i="purchase",o="purchased",m=`Order ${a.order_id||"Unknown"}`,z=a.total;break;case"page_view":i="page_view",o="viewed",m="Page View";break;case"product_view":i="product_view",o="viewed",m=a.product_name||"Product";break;default:i="click",o="browsed"}return{id:`event-${t.id}`,type:i,productName:m,productUrl:t.url||"",status:o,amount:z,timestamp:t.timestamp,userAgent:t.userAgent,referrer:t.referrer,ip:t.ipAddress,eventData:a,platform:t.platform,sessionId:t.sessionId}})];J.sort((t,a)=>new Date(a.timestamp).getTime()-new Date(t.timestamp).getTime()),M(J);const R=I.length,_=P.length+l.filter(t=>t.eventType==="purchase").length,T=l.filter(t=>t.eventType==="add_to_cart").length,H=P.reduce((t,a)=>t+(a.amount||0),0)+l.filter(t=>t.eventType==="purchase").reduce((t,a)=>{const i=typeof a.eventData=="string"?JSON.parse(a.eventData):a.eventData;return t+(i.total||0)},0),ee=R>0?_/R*100:0;W({totalClicks:R,totalPurchases:_,totalRevenue:H,conversionRate:ee,totalAddToCart:T,totalPageViews:l.filter(t=>t.eventType==="page_view").length,totalProductViews:l.filter(t=>t.eventType==="product_view").length,cartToPurchaseRate:T>0?_/T*100:0,averageOrderValue:H/_,totalSessions:new Set(l.map(t=>t.sessionId)).size})}catch(c){console.error("Error fetching activity:",c),B("Failed to load activity data. Please try again.")}finally{D(!1),$(!1)}},V=()=>{O(!0)},F=s=>{try{const u=new URL(s).pathname.split("/").filter(Boolean);return u[u.length-1]||"Product"}catch{return"Product"}},X=s=>{switch(s){case"purchased":return e.jsx(h,{className:"bg-green-500/20 text-green-300 border-0",children:"Purchased"});case"browsed":return e.jsx(h,{className:"bg-blue-500/20 text-blue-300 border-0",children:"Browsed"});case"abandoned":return e.jsx(h,{className:"bg-red-500/20 text-red-300 border-0",children:"Abandoned"});case"added_to_cart":return e.jsx(h,{className:"bg-orange-500/20 text-orange-300 border-0",children:"Added to Cart"});case"viewed":return e.jsx(h,{className:"bg-purple-500/20 text-purple-300 border-0",children:"Viewed"});default:return e.jsx(h,{variant:"outline",className:"text-white border-white/30",children:s})}},Y=s=>{switch(s){case"click":return e.jsx(p,{className:"h-4 w-4 text-blue-600"});case"purchase":case"conversion":return e.jsx(S,{className:"h-4 w-4 text-green-600"});case"add_to_cart":return e.jsx(S,{className:"h-4 w-4 text-orange-600"});case"page_view":return e.jsx(p,{className:"h-4 w-4 text-purple-600"});case"product_view":return e.jsx(p,{className:"h-4 w-4 text-indigo-600"});default:return e.jsx(p,{className:"h-4 w-4"})}},Z=s=>new Date(s).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),E=K.filter(s=>r==="clicks"?s.type==="click":r==="purchases"?s.type==="purchase":r==="add_to_cart"?s.type==="add_to_cart":r==="page_views"?s.type==="page_view":!0);return Q&&!v?e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-8 bg-gray-200 rounded w-1/4 mb-4"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-6",children:[...Array(4)].map((s,c)=>e.jsx("div",{className:"h-24 bg-gray-200 rounded"},c))}),e.jsx("div",{className:"h-64 bg-gray-200 rounded"})]})}):U?e.jsxs("div",{className:"space-y-6 text-white",children:[e.jsxs("div",{className:"flex items-center gap-2 text-red-400",children:[e.jsx(te,{className:"h-5 w-5"}),e.jsx("p",{children:U})]}),e.jsxs(d,{onClick:V,className:"bg-red-500 hover:bg-red-600 text-white",children:[e.jsx(q,{className:"h-4 w-4 mr-2"}),"Refresh Data"]})]}):e.jsxs("div",{className:"space-y-6 text-white",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs(w,{className:"border-white/10 bg-white/5 text-white",children:[e.jsxs(g,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(f,{className:"text-sm font-medium text-white",children:"Total Clicks"}),e.jsx(p,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(j,{children:[e.jsx("div",{className:"text-2xl font-bold",children:y.totalClicks.toLocaleString()}),e.jsx("p",{className:"text-xs text-white/80",children:"Product page visits"})]})]}),e.jsxs(w,{className:"border-white/10 bg-white/5 text-white",children:[e.jsxs(g,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(f,{className:"text-sm font-medium text-white",children:"Total Purchases"}),e.jsx(S,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(j,{children:[e.jsx("div",{className:"text-2xl font-bold",children:y.totalPurchases.toLocaleString()}),e.jsx("p",{className:"text-xs text-white/80",children:"Successful conversions"})]})]}),e.jsxs(w,{className:"border-white/10 bg-white/5 text-white",children:[e.jsxs(g,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(f,{className:"text-sm font-medium text-white",children:"Total Revenue"}),e.jsx(se,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(j,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:["$",y.totalRevenue.toLocaleString()]}),e.jsx("p",{className:"text-xs text-white/80",children:"Revenue from purchases"})]})]}),e.jsxs(w,{className:"border-white/10 bg-white/5 text-white",children:[e.jsxs(g,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(f,{className:"text-sm font-medium text-white",children:"Conversion Rate"}),e.jsx(ae,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(j,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[y.conversionRate.toFixed(1),"%"]}),e.jsx("p",{className:"text-xs text-white/80",children:"Click to purchase ratio"})]})]})]}),e.jsxs("div",{className:"flex gap-2 items-center flex-wrap",children:[e.jsx(d,{onClick:()=>x("all"),className:`${r==="all"?"bg-white text-black":"bg-white/10 text-white hover:bg-white/20"} rounded-full`,children:"All Activity"}),e.jsx(d,{onClick:()=>x("clicks"),className:`${r==="clicks"?"bg-white text-black":"bg-white/10 text-white hover:bg-white/20"} rounded-full`,children:"Clicks Only"}),e.jsx(d,{onClick:()=>x("add_to_cart"),className:`${r==="add_to_cart"?"bg-white text-black":"bg-white/10 text-white hover:bg-white/20"} rounded-full`,children:"Add to Cart"}),e.jsx(d,{onClick:()=>x("purchases"),className:`${r==="purchases"?"bg-white text-black":"bg-white/10 text-white hover:bg-white/20"} rounded-full`,children:"Purchases Only"}),e.jsx(d,{onClick:()=>x("page_views"),className:`${r==="page_views"?"bg-white text-black":"bg-white/10 text-white hover:bg-white/20"} rounded-full`,children:"Page Views"}),e.jsxs(d,{onClick:V,disabled:v,className:"bg-white/10 text-white hover:bg-white/20 rounded-full ml-auto",children:[e.jsx(q,{className:`h-4 w-4 mr-2 ${v?"animate-spin":""}`}),v?"Refreshing...":"Refresh"]})]}),e.jsxs(w,{className:"border-white/10 bg-white/5 text-white",children:[e.jsx(g,{children:e.jsx(f,{className:"text-white",children:"Recent Activity"})}),e.jsx(j,{children:E.length===0?e.jsx("div",{className:"text-center py-8 text-white/70",children:e.jsx("p",{children:"No activity found for the selected filter."})}):e.jsxs(ie,{children:[e.jsx(ce,{children:e.jsxs(G,{children:[e.jsx(b,{className:"text-white",children:"Type"}),e.jsx(b,{className:"text-white",children:"Product"}),e.jsx(b,{className:"text-white",children:"Status"}),e.jsx(b,{className:"text-white",children:"Amount"}),e.jsx(b,{className:"text-white",children:"Date"})]})}),e.jsx(le,{children:E.slice(0,20).map(s=>e.jsxs(G,{children:[e.jsx(N,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[Y(s.type),e.jsx("span",{className:"capitalize text-white",children:s.type})]})}),e.jsx(N,{children:e.jsx("div",{className:"max-w-xs truncate",children:e.jsx("a",{href:s.productUrl,target:"_blank",rel:"noopener noreferrer",className:"text-white hover:underline",children:s.productName})})}),e.jsx(N,{children:X(s.status)}),e.jsx(N,{children:e.jsx("span",{className:"text-white",children:s.amount?`$${s.amount.toFixed(2)}`:"-"})}),e.jsx(N,{children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(re,{className:"h-3 w-3 text-muted-foreground"}),e.jsx("span",{className:"text-white/80",children:Z(s.timestamp)})]})})]},s.id))})]})})]})]})}export{we as default};
